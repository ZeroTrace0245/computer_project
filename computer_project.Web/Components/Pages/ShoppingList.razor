@page "/shoppinglist"
@using computer_project.Web.Models
@using computer_project.Web.Services
@inject SmartBiteApiClient ApiClient
@inject UserSession Session
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Shopping List</PageTitle>

<ConsumerOnly>
    <h1>Shopping List</h1>

    <div class="row">
        <div class="col-lg-9">
            <div class="card mb-4 shadow-sm border-0 overflow-hidden">
                <div class="card-body p-3">
                    <div class="d-flex gap-2 align-items-stretch">
                        <div class="flex-grow-1">
                            <input class="form-control form-control-lg border-2 shadow-none h-100" @bind="newItemName" placeholder="What do you need to buy?" />
                        </div>
                        <div class="d-flex align-items-center gap-2 bg-light px-3 rounded-3 border border-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                            <select class="form-select form-select-sm border-0 bg-transparent fw-bold shadow-none p-0 pe-4" style="min-width: 130px;" @bind="newPaymentMethod">
                                <option value="Cash">Cash</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Apple Pay">Apple Pay</option>
                                <option value="Google Pay">Google Pay</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <button class="btn btn-primary px-4 fw-bold shadow-sm" @onclick="AddItem">
                            <div class="d-flex align-items-center gap-2">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                <span>Add Item</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    @if (items == null)
                    {
                        <div class="p-4 text-center">
                            <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                            <span class="ms-2">Loading items...</span>
                        </div>
                    }
                    else if (!FilteredItems.Any())
                    {
                        <div class="p-4 text-center text-muted">No items matching your search.</div>
                    }
                    else
                    {
                        <div class="list-group list-group-flush rounded-bottom border-top">
                            @foreach (var item in FilteredItems)
                            {
                                <div class="list-group-item d-flex align-items-center justify-content-between border-0 py-3 px-4 transition-all">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="form-check m-0">
                                            <input class="form-check-input shadow-none" type="checkbox" checked="@item.IsPurchased" @onchange="@(e => TogglePurchased(item))" id="@($"item-{item.Id}")" />
                                            <label class="form-check-label @(item.IsPurchased ? "text-decoration-line-through text-muted" : "fw-bold") ms-1" for="@($"item-{item.Id}")">
                                                @item.ItemName
                                            </label>
                                        </div>
                                        <span class="badge @(item.IsPurchased ? "bg-light text-muted" : "bg-primary-subtle text-primary") rounded-pill px-3 py-2 border-0">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                                            @item.PaymentMethod
                                        </span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-light border-0 shadow-none rounded-circle p-2" type="button" data-bs-toggle="dropdown">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-2 rounded-3">
                                                <li class="dropdown-header small text-uppercase fw-bold text-muted p-2">Change Payment</li>
                                                <li><button class="dropdown-item rounded-2 py-2 d-flex align-items-center" @onclick='() => ChangePaymentMethod(item, "Cash")'><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Cash</button></li>
                                                <li><button class="dropdown-item rounded-2 py-2 d-flex align-items-center" @onclick='() => ChangePaymentMethod(item, "Credit Card")'><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg> Card</button></li>
                                                <li><button class="dropdown-item rounded-2 py-2 d-flex align-items-center" @onclick='() => ChangePaymentMethod(item, "Apple Pay")'><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><path d="M12 20.94c1.88 0 3.05-1.07 3.05-1.07s-1.15-1.18-1.51-1.58c-.36-.4-.53-.9-.49-1.42c.04-.52.28-.98.66-1.28c.38-.3.87-.41 1.34-.31c.47.1 1.15.54 1.15.54s-.32-4.57-3.96-4.57s-3.96 4.54-3.96 4.54s1.28-.59 1.77-.38c.49.21.73.69.69 1.21c-.04.52-.3 1-.72 1.3c-.42.3-.92.38-1.41.22c-.49-.16-1.17-.67-1.17-.67s.67 3.69 3.56 3.69z"/><path d="M12 8a3 3 0 0 1 3 3v1a3 3 0 0 1-6 0v-1a3 3 0 0 1 3-3z"/></svg> Apple Pay</button></li>
                                                <li><button class="dropdown-item rounded-2 py-2 d-flex align-items-center" @onclick='() => ChangePaymentMethod(item, "Google Pay")'><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> G-Pay</button></li>
                                            </ul>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger border-0" title="Delete item" @onclick="() => DeleteItem(item)">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
                @if (items != null && items.Any(i => !i.IsPurchased) && !isProcessingOrder)
                {
                    <div class="card-footer border-0 p-3 bg-white text-end">
                        <button class="btn btn-success px-5 fw-bold shadow-sm rounded-pill py-2" @onclick="StartCheckout">
                            <div class="d-flex align-items-center gap-2">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                                <span>Confirm & Pay (@items.Count(i => !i.IsPurchased) items)</span>
                            </div>
                        </button>
                    </div>
                }
            </div>

            @if (isProcessingOrder)
            {
                <div class="card mt-4 shadow-lg border-0 bg-dark text-white overflow-hidden fade-in">
                    <div class="card-header border-0 bg-dark bg-opacity-50 py-3 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                            <div class="spinner-grow spinner-grow-sm text-success" role="status"></div>
                            <h5 class="mb-0 fw-bold ls-wide">LIVE ORDER TRACKER</h5>
                        </div>
                        <span class="badge bg-success text-uppercase ls-wider">Active Delivery</span>
                    </div>
                    <div class="card-body p-4">
                        <!-- Progress Bar with Checkpoints -->
                        <div class="position-relative mb-5 px-3">
                            <div class="progress bg-secondary bg-opacity-25" style="height: 6px;">
                                <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: @(orderProgress)%; transition: width 0.5s ease;"></div>
                            </div>

                            <!-- Checkpoints -->
                            <div class="d-flex justify-content-between position-absolute top-50 start-0 end-0 translate-middle-y px-3">
                                <div class="checkpoint @(orderProgress >= 0 ? "active" : "")">
                                    <div class="dot shadow-sm d-flex align-items-center justify-content-center">
                                        <svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6L9 17l-5-5"/></svg>
                                    </div>
                                    <div class="label small text-uppercase mt-2">Paid</div>
                                </div>
                                <div class="checkpoint @(orderProgress >= 25 ? "active" : "")">
                                    <div class="dot shadow-sm d-flex align-items-center justify-content-center">
                                        <svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                                    </div>
                                    <div class="label small text-uppercase mt-2">Prepared</div>
                                </div>
                                <div class="checkpoint @(orderProgress >= 50 ? "active" : "")">
                                    <div class="dot shadow-sm d-flex align-items-center justify-content-center">
                                        <svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor"><path d="M10 17h4V5H2v12h3m10 0h3l4-4h-7m-7 3a2 2 0 1 0 4 0 2 2 0 1 0-4 0m10 0a2 2 0 1 0 4 0 2 2 0 1 0-4 0"/></svg>
                                    </div>
                                    <div class="label small text-uppercase mt-2">Transit</div>
                                </div>
                                <div class="checkpoint @(orderProgress >= 75 ? "active" : "")">
                                    <div class="dot shadow-sm d-flex align-items-center justify-content-center">
                                        <svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6v6l4 2"/></svg>
                                    </div>
                                    <div class="label small text-uppercase mt-2">Nearby</div>
                                </div>
                                <div class="checkpoint @(orderProgress >= 100 ? "active" : "")">
                                    <div class="dot shadow-sm d-flex align-items-center justify-content-center">
                                        <svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                                    </div>
                                    <div class="label small text-uppercase mt-2">Done</div>
                                </div>
                            </div>
                        </div>

                        <!-- Terminal Output -->
                        <div class="terminal bg-black rounded-3 p-3 font-monospace small" style="height: 180px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1);">
                            <div class="text-success mb-2 border-bottom border-success border-opacity-25 pb-1">> System initialized... Connection secure.</div>
                            @foreach (var log in orderLogs)
                            {
                                <div class="mb-1 d-flex gap-2">
                                    <span class="text-muted">[@DateTime.Now.ToString("HH:mm:ss")]</span>
                                    <span class="@(log.Contains("!") ? "text-warning" : "text-light")">@log</span>
                                </div>
                            }
                            @if (orderProgress < 100)
                            {
                                <div class="text-success opacity-50 blinking-cursor">_</div>
                            }
                        </div>
                    </div>
                    @if (orderProgress >= 100)
                    {
                        <div class="card-footer border-0 bg-success bg-opacity-10 p-3 text-center">
                            <button class="btn btn-outline-success btn-sm px-4 fw-bold" @onclick="() => isProcessingOrder = false">Close Monitor</button>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</ConsumerOnly>

<style>
    .checkpoint { text-align: center; width: 60px; }
    .checkpoint .dot { width: 14px; height: 14px; background: #6c757d; border-radius: 50%; border: 3px solid #343a40; margin: 0 auto; transition: all 0.3s; }
    .checkpoint.active .dot { background: #198754; border-color: #d1e7dd; transform: scale(1.2); box-shadow: 0 0 10px rgba(25, 135, 84, 0.5); }
    .checkpoint .label { font-size: 0.65rem; color: #adb5bd; font-weight: bold; }
    @@media (max-width: 575px) {
        .checkpoint { width: 45px; }
        .checkpoint .label { font-size: 0.5rem; }
    }
    .checkpoint.active .label { color: #fff; }
    .terminal::-webkit-scrollbar { width: 6px; }
    .terminal::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    .blinking-cursor { animation: blink 1s step-end infinite; }
    @@keyframes blink { 50% { opacity: 0; } }
    .transition-all { transition: all 0.2s ease-in-out; }
</style>

@code {
    private List<ShoppingListItem>? items;
    private string newItemName = "";
    private string newPaymentMethod = "Cash";

    private IEnumerable<ShoppingListItem> FilteredItems => items?
        .Where(i => string.IsNullOrWhiteSpace(Session.SearchQuery) || 
                    i.ItemName.Contains(Session.SearchQuery, StringComparison.OrdinalIgnoreCase)) ?? 
        Enumerable.Empty<ShoppingListItem>();

    // Order Tracking State
    private bool isProcessingOrder = false;
    private int orderProgress = 0;
    private List<string> orderLogs = new();

    protected override async Task OnInitializedAsync()
    {
        Session.OnChange += StateHasChanged;
        await LoadItems();
    }

    public void Dispose()
    {
        Session.OnChange -= StateHasChanged;
    }

    private async Task StartCheckout()
    {
        isProcessingOrder = true;
        orderProgress = 0;
        orderLogs.Clear();

        await TrackOrder();
    }

    private async Task TrackOrder()
    {
        string[] statusUpdates = {
            "PAYMENT CONFIRMED via " + newPaymentMethod + ". Verifying funds...",
            "WAREHOUSE: Order received. Scanning SKU codes...",
            "PICKING: 3 items identified and moved to packaging bin.",
            "PACKING: Thermal insulation applied to perishable items.",
            "COURIER: Driver assigned. Heading to pickup location...",
            "TRANSIT: Your order is at the Central Hub. Sorting complete.",
            "TRANSIT: Vehicle is in your area. GPS coordination active.",
            "LOCATION: Your order is at Downtown Crossing - 2 miles away.",
            "LOCATION: Your order is 5 min away! Arriving at your street.",
            "DELIVERED: Package left at front door. Enjoy your meal!"
        };

        for (int i = 0; i < statusUpdates.Length; i++)
        {
            if (!isProcessingOrder) break;

            orderLogs.Insert(0, statusUpdates[i]);
            orderProgress = (i + 1) * 10;

            if (orderProgress == 100 && items != null)
            {
                foreach(var item in items.Where(it => !it.IsPurchased))
                {
                    item.IsPurchased = true;
                    await ApiClient.UpdateShoppingListItemAsync(item);
                }
            }

            StateHasChanged();

            // Total time approx 3 mins (18s * 10 steps)
            await Task.Delay(18000); 
        }
    }

    private async Task LoadItems()
{
    items = await ApiClient.GetShoppingListAsync();
}

    private async Task AddItem()
    {
        if (string.IsNullOrWhiteSpace(newItemName)) return;

        var item = new ShoppingListItem
        {
            ItemName = newItemName,
            IsPurchased = false,
            PaymentMethod = newPaymentMethod,
            UserId = 1
        };

        await ApiClient.AddShoppingListItemAsync(item);
        newItemName = "";
        await LoadItems();
    }

    private async Task ChangePaymentMethod(ShoppingListItem item, string method)
    {
        item.PaymentMethod = method;
        await ApiClient.UpdateShoppingListItemAsync(item);
        // UI updates automatically because item is reference
    }

    private async Task TogglePurchased(ShoppingListItem item)
    {
        item.IsPurchased = !item.IsPurchased;
        await ApiClient.UpdateShoppingListItemAsync(item);
        await LoadItems();
    }

    private async Task DeleteItem(ShoppingListItem item)
    {
        await ApiClient.DeleteShoppingListItemAsync(item.Id);
        await LoadItems();
    }
}
